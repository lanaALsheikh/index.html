<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>محاكي صوت الكأس</title>
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --accent: #7dd3fc;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Almarai', sans-serif;
      background: linear-gradient(180deg, #071026 0%, #0b1220 100%);
      color: #e6eef6;
      display: flex;
      flex-direction: column;
    }
    .wrap {
      flex: 1;
      padding: 16px;
      max-width: 960px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    h1 {
      font-size: 20px;
      margin: 0;
    }
    p {
      margin: 0;
      color: #a8b6c8;
      font-size: 14px;
    }
    canvas {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: linear-gradient(180deg,#06202b, #071428);
      border-radius: 10px;
      display: block;
      touch-action: none;
    }
    .controls {
      padding: 12px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 10px;
      color: #cfe8ff;
    }
    input[type=range] {
      width: 100%;
    }
    button {
      margin-top: 12px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 0;
      background: var(--accent);
      color: #012029;
      font-weight: 600;
      width: 100%;
    }
    .credits {
      margin-top: 10px;
      font-size: 12px;
      color: #7f99b0;
    }
    .author {
      margin-top: 16px;
      font-size: 15px;
      color: #7dd3fc;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>محاكي صوت الكأس</h1>
    <p>حرّك بإصبعك أو الماوس حول الدائرة لتوليد الصوت.</p>

    <canvas id="c"></canvas>

    <div class="controls">
      <label>الحجم (نغمة القاعدة)</label>
      <input id="size" type="range" min="0.5" max="2.0" step="0.01" value="1.0" />

      <label>حساسية الحركة</label>
      <input id="sensitivity" type="range" min="0.2" max="5.0" step="0.1" value="1.6" />

      <label>رنين (Q)</label>
      <input id="q" type="range" min="2" max="40" step="1" value="18" />

      <label>مستوى الصدى</label>
      <input id="reverb" type="range" min="0" max="1" step="0.01" value="0.28" />

      <button id="start">تشغيل / إيقاف الصوت</button>
      <div class="credits">تم باستخدام Web Audio API</div>
    </div>

    <div class="author">لانا محمد الشيخ</div>
  </div>

  <script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('start');
    const sizeR = document.getElementById('size');
    const sensR = document.getElementById('sensitivity');
    const qR = document.getElementById('q');
    const revR = document.getElementById('reverb');

    let audioCtx = null;
    let masterGain, noiseBuf, noiseSrc, resonators = [], convolver;
    let center = { x: 0, y: 0 }, radius = 0;
    let pointerDown = false, pointer = null;
    let lastAngle = null, lastTime = null, angularSpeed = 0;
    let running = false;

    function setupAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.03;
      masterGain.connect(audioCtx.destination);

      const bufferSize = 2 * audioCtx.sampleRate;
      noiseBuf = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = noiseBuf.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * 0.6;

      convolver = audioCtx.createConvolver();
      const ir = audioCtx.createBuffer(2, audioCtx.sampleRate * 2, audioCtx.sampleRate);
      for (let ch = 0; ch < 2; ch++) {
        const id = ir.getChannelData(ch);
        for (let i = 0; i < ir.length; i++) id[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / ir.length, 2);
      }
      convolver.buffer = ir;
      convolver.normalize = true;
      convolver.connect(masterGain);

      const base = 420;
      for (let i = 0; i < 6; i++) {
        const f = base * [1, 1.35, 1.9, 2.6, 3.5, 4.4][i];
        const osc = audioCtx.createOscillator();
        osc.type = 'sine';
        osc.frequency.value = f;
        const g = audioCtx.createGain();
        g.gain.value = 0;
        osc.connect(g);
        g.connect(masterGain);
        osc.start();
        resonators.push({ osc, g, f });
      }
    }

    function startNoise() {
      if (!audioCtx) setupAudio();
      noiseSrc = audioCtx.createBufferSource();
      noiseSrc.buffer = noiseBuf;
      noiseSrc.loop = true;
      const bp = audioCtx.createBiquadFilter();
      bp.type = 'bandpass'; bp.frequency.value = 1200; bp.Q.value = qR.value;
      const g = audioCtx.createGain(); g.gain.value = 0;
      noiseSrc.connect(bp); bp.connect(g); g.connect(convolver);
      noiseSrc.start();
      convolver.connect(masterGain);
    }

    function stopNoise() {
      if (noiseSrc) { try { noiseSrc.stop(); } catch (e) { } noiseSrc.disconnect(); noiseSrc = null; }
    }

    function pointerToAngle(x, y) {
      return Math.atan2(y - center.y, x - center.x);
    }

    function onPointer(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      const ang = pointerToAngle(x, y);
      const now = performance.now();
      if (lastAngle != null && lastTime != null) {
        let delta = ang - lastAngle;
        while (delta > Math.PI) delta -= Math.PI * 2;
        while (delta < -Math.PI) delta += Math.PI * 2;
        const dt = (now - lastTime) / 1000;
        const angSpeed = delta / dt;
        angularSpeed = angularSpeed * 0.6 + angSpeed * 0.4;
        driveAudioFromSpeed(Math.abs(angularSpeed));
      }
      lastAngle = ang; lastTime = now;
    }

    function driveAudioFromSpeed(speed) {
      const sens = parseFloat(sensR.value);
      const amp = Math.min(speed * sens, 1);
      if (resonators.length) {
        resonators.forEach((r, i) => {
          const spread = 0.7 + (i * 0.15);
          r.g.gain.value = amp * (1 / spread);
          r.osc.frequency.value = r.f * parseFloat(sizeR.value);
        });
      }
      if (convolver) convolver.gain.value = amp * parseFloat(revR.value);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.arc(center.x, center.y, radius, 0, Math.PI * 2);
      ctx.strokeStyle = "#7dd3fc";
      ctx.lineWidth = 4;
      ctx.stroke();
      requestAnimationFrame(draw);
    }

    function resize() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      center.x = canvas.width / 2;
      center.y = canvas.height / 2;
      radius = canvas.width / 2.5;
    }

    window.addEventListener('resize', resize);
    resize();
    draw();

    canvas.addEventListener('pointerdown', e => { pointerDown = true; onPointer(e); });
    canvas.addEventListener('pointermove', e => { if (pointerDown) onPointer(e); });
    canvas.addEventListener('pointerup', e => { pointerDown = false; angularSpeed = 0; });
    canvas.addEventListener('touchmove', onPointer);
    canvas.addEventListener('touchstart', onPointer);
    canvas.addEventListener('touchend', () => { angularSpeed = 0; });

    startBtn.addEventListener('click', () => {
      running = !running;
      if (running) startNoise(); else stopNoise();
    });
  </script>
</body>
</html>



